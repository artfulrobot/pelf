<div class="crm-container">
  <h1 crm-page-title>{{ pageTitle }}</h1>

  <a href ng-click="reload()">Reload</a>

  <!-- @todo filters -->
  <div class="messages" ng-if="state == 'loading'" >
    Please wait...
  </div>
  <div ng-if="state == 'loaded'" >

    <!-- ====================================== Form ====================================== -->
    <form crm-ui-id-scope name="pelf_filters">
      <div class="pelf-browse__filters">
        <div class="pelf-browse__filter">
          <label crm-ui-for="filters_status">Status</label>
          <input
            ng-list
            crm-ui-id="filters_status"
            crm-ui-select="{allowClear:true, width: '14rem', multiple: true, data: statusFilterOptions }"
            ng-model="filters.status"
            name="status_filter"
            />
        </div>


        <div class="pelf-browse__filter">
          <label crm-ui-for="filters_projects">Projects</label>
          <input
            ng-list
            crm-ui-id="filters_projects"
            crm-ui-select="{allowClear:true, width: '14rem', multiple: true, data: projectsFilterOptions }"
            ng-model="filters.projects"
            name="projects_filter"
            />
        </div>

        <div class="pelf-browse__filter">
          <label crm-ui-for="filters_fys">Years</label>
          <input
            ng-list
            crm-ui-id="filters_fys"
            crm-ui-select="{allowClear:true, width: '9rem', multiple: true, data: yearsFilterOptions }"
            ng-model="filters.years"
            name="projects_fys"
            />
        </div>

        <div class="pelf-browse__filter">
          <input crm-ui-id="filters_adjusted"
                 type="checkbox"
                 ng-model="filters.adjusted" />
          <label crm-ui-for="filters_adjusted">Show adjusted worth</label>
        </div>
      </div>
    </form>
    <!-- ====================================== Summary ====================================== -->

    <div class="pelf-summary-tables">
      <div class="pelf-summary-tables__table">
        <pelf-pivot
          source-rows="filteredFunds"
          projects="projects"
          pivot-type="'full'"
          cases="cases"
          show-adjusted="filters.adjusted"
          table-class="'pelf-financial'"
          ></pelf-pivot>
      </div>
      <div class="pelf-summary-tables__table">
        <!-- by status -->

        <pelf-pivot
          source-rows="filteredFunds"
          projects="projects"
          cases="cases"
          case-statuses="case_statuses"
          show-adjusted="filters.adjusted"
          pivot-type="'by_status'"
          table-class="'pelf-financial by-status'"
          ></pelf-pivot>
      </div>
    </div>


    <!-- ====================================== Listings ====================================== -->
    <div class="pelf-browse__filters case-items">
      <div class="pelf-browse__case-items-option">
        <label for="pelf-sort">Sort by</label>
        <select id="pelf-sort" ng-model="filters.sort" >
          <option value="Status">Status</option>
          <option value="Worth">Worth</option>
          <option value="Adjusted Worth">Adjusted Worth</option>
        </select>

      </div>
      <div class="pelf-browse__case-items-option">
        Show:
        <span ng-class="(listDetails == 'financial') ? 'pelf-browse__details-selected' : 'pelf-browse__details-deselected' "
              ng-click="listDetails = 'financial'">Financial</span>
        <span ng-class="(listDetails == 'activity') ? 'pelf-browse__details-selected' : 'pelf-browse__details-deselected' "
              ng-click="listDetails = 'activity'">Activity</span>
      </div>
    </div>

    <ul class="pelf-browse__table">
      <li ng-repeat="venture in sortedCases"
          class="pelf-browse__case {{ case_statuses[venture.status_id].grouping }}"
          style="border-left-color: {{case_statuses[venture.status_id].color}}"
          >
          <article class="pelf-browse__case-item">
            <div class="pelf-browse__case-meta">
              {{ case_statuses[venture.status_id].label }}
              <!-- todo: priority -->
            </div>
            <div class="pelf-browse__case-name">
              <h1><a href="{{ venture.ventureUrl }}" >{{ venture.subject }}</a></h1>
              <div ng-repeat="client_id in venture.clients">
                <a href="{{ crmURL('civicrm/contact/view', {cid: client_id, reset:1}) }}">{{ clients[client_id].display_name }}</a>
              </div>
            </div>
            <div class="pelf-browse__case-value">
              <div>&pound;{{ pelfMoney(venture.funds_total, venture) }}</div><!-- @todo lookup local currency -->
              <small>{{ venture.worth_percent }}%</small>
            </div>

            <div class="pelf-browse__case-allocations" ng-if="listDetails === 'financial'">

              <pelf-pivot
                source-rows="venture.funds"
                projects="projects"
                cases="cases"
                case-statuses="case_statuses"
                show-adjusted="filters.adjusted"
                pivot-type="'project'"
                table-class="'pelf-financial'"
                ></pelf-pivot>

            </div>

            <div class="pelf-browse__case-activities" ng-if="listDetails === 'activity'">
              <div ng-if="venture.activityLast">
                Last: {{venture.activityLast.activity_type}} {{venture.activityLast.activity_date_time}}<br/>
                <div>{{venture.activityLast.subject}}</div>
                <div><i class="crm-i">&#xf2bd;</i> {{venture.activityLast.assigees}}</div>
              </div>
              <div ng-if="venture.activityNext">
                Next: {{venture.activityNext.activity_type}} {{venture.activityNext.activity_date_time}}<br/>
                <div>{{venture.activityNext.subject}}</div>
                <div><i class="crm-i">&#xf2bd;</i> {{venture.activityNext.assigees}}</div>
              </div>
              <div ng-if="!venture.activityNext">
                Next: Nothing scheduled
              </div>
            </div>
          </article>
      </li>
    </ul>

  </div>


</div>
